

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/myImg/favicon.png">
  <link rel="icon" href="/myImg/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="风轻云淡，于事安然。">
  <meta name="author" content="AnderGH">
  <meta name="keywords" content="">
  
  <title>iOS关于RSA的一些基础知识 - AnderGH&#39;s blogs</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"andergh.github.io","root":"/","version":"1.8.9-a","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":false,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":6},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>AnderGH's blogs</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/myImg/lineargradient.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="iOS关于RSA的一些基础知识">
              
                iOS关于RSA的一些基础知识
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-11-04 15:10" pubdate>
        2019年11月4日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">iOS关于RSA的一些基础知识</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：8 个月前
                
              </p>
            
            <div class="markdown-body">
              <h4 id="一、基础概念"><a href="#一、基础概念" class="headerlink" title="一、基础概念"></a>一、基础概念</h4><ul>
<li><p><code>RSA</code>加密算法是最常用的非对称加密算法，目前普遍认为是最优秀的方案之一，关于<code>RSA</code>的数学原理和方法，这里不做说明，感兴趣的可以自行了解下。本文主要介绍<code>RSA</code>的一些常用的基础知识</p>
</li>
<li><p><code>RSA</code>分为公钥和私钥，生成时会需要传入参数，秘钥位数和秘钥格式，秘钥位数有<code>512bit</code>、<code>1024bit</code>、<code>2048bit</code>等，通常使用的是<code>1024bit</code>，私钥格式分为<code>PKCS8</code>和<code>PKCS1</code>，其中<code>PKCS8</code>为<code>java</code>语言中使用的格式，<code>PKCS1</code>为<code>iOS</code>相关语言中使用的格式。</p>
</li>
<li><p>通常生成的秘钥会保存在<code>.pem</code>格式的文件中，使用文本编辑器或者代码编辑器打开，可以查看到保存的值，如果是按<code>1024bit</code>取模，<code>PKCS1</code>格式的私钥长度应该是<code>824</code>（包含回车），如果是<code>PKCS8</code>的格式的密钥长度为<code>861</code></p>
</li>
<li><p>通常<code>RSA</code>有两种用法，公钥加密私钥解密和私钥签名公钥验签，加密是为了数据保密，签名是为了防恶意攻击，例如防止别人模拟我们的客户端对我们的服务器进行攻击，导致服务器瘫痪等</p>
</li>
</ul>
<h4 id="二、一些在线网站"><a href="#二、一些在线网站" class="headerlink" title="二、一些在线网站"></a>二、一些在线网站</h4><p>有一些网站可以在线生成<code>RSA</code>秘钥，例如<a target="_blank" rel="noopener" href="http://web.chacuo.net/netrsakeypair">http://web.chacuo.net/netrsakeypair</a>，这些网站可以便捷的生成私钥，并自动得出相应的公钥，以及能在线转换格式，加密解密等</p>
<h4 id="三、命令行生成命令"><a href="#三、命令行生成命令" class="headerlink" title="三、命令行生成命令"></a>三、命令行生成命令</h4><p>我们先了解下一个软件包<code>OpenSSL</code>，<code>OpenSSL</code>是为网络通信提供安全及数据完整性的一种安全协议，囊括了主要的密码算法、常用的密钥和证书封装管理功能以及<code>SSL</code>协议，并提供了丰富的应用程序供测试或其它目的使用。<code>LibreSSL</code>是<code>OpenSSL</code>加密软件库的一个分支。在<code>OpenSS</code>L爆出安全漏洞之后，于2014年4月创立，目标是重构<code>OpenSSL</code>的代码，以提供一个更安全的替代品。所以通过在电脑上安装<code>OpenSSL</code>或者<code>LibreSSL</code>后，即可通过相关的命令行生成秘钥。<code>mac</code>电脑已自带<code>LibreSSL</code>，如果没有，可以寻找相关的安装方法，此处不再扩展</p>
<h5 id="1、基础生成命令"><a href="#1、基础生成命令" class="headerlink" title="1、基础生成命令"></a>1、基础生成命令</h5><ol>
<li>生成模长为<code>1024bit</code>的私钥</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ openssl genrsa -out <span class="hljs-regexp">/xx/</span>xx/private_pkcs1.pem <span class="hljs-number">1024</span><br></code></pre></td></tr></table></figure>
<p><code>private_pkcs1.pem</code>前为本地路径，<code>pem</code>文件会生成到制定目录，长度<code>824</code>，此命令行生成的为<code>PKCS1</code>格式的私钥，如下</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">-----<span class="hljs-keyword">BEGIN</span> RSA PRIVATE KEY-----<br>MIICXgIBAAKBgQDWa6g5OgPyB5xCkvEIitA1gKOBoQi21nAVJL7iVMqkA2MrhmUl<br>ZonITpqMW3syTtaksMualat1CmqJRQaDn+UVe0u2Wgtvvu8KaDdbDa6Tyq6S2K89<br>GI2l/AzouLE06daaHDh3qjtwNmEDqsK7mEcSPddIKaIOHZ7bKzOkbYnGEwIDAQAB<br>AoGBAIiOY8KeaijYI<span class="hljs-regexp">/JaNtuj3FpWpMtHzY70Hsm4b0EhkzTFW4E6xGv/</span>U7yYIuFE<br><span class="hljs-number">2</span>b7+asDUP7chnuKZUaQ+q5lkWbYcKsSWORgGBUeYUOVoU9SuTp65oFKkc9AOtaxz<br>VavX536Y1VRtT+b8mB++gZwp5cZHUbJTj4BPSKH7IJawKskRAkEA7jA4c+I3ZfFD<br>koOl41x3cvwH+xQLi6vpL6Gw3/muJrc6mtdZbcuXwjMYlac++mXPTUt1K4b1sUmG<br>G3qwnkUjXwJBAOZ0b2fZhRhsDzNFihnD1PXGNl56FVG3G0aWZzQIHQX1DIE+sG4k<br>CJxrqxTnHWc+O2ODPU2PbJUN0fcpEuoDbc0CQQC9LpWYDUP89yy5cVDQDgBd1qos<br>FRa6f/d9Ooq2yqQ04fFtTMAeAcfumhDbxHO0BCsr9FQDF3WLs58NslwXyUg3AkBg<br>GK1b4JhfVq<span class="hljs-regexp">//</span><span class="hljs-number">8</span>T9k<span class="hljs-regexp">/wQOeFizjLTXHkOBa7YdPETd9xD/</span><span class="hljs-number">0</span>+Q+CUiN8Veln7njE1Aw<br>bslhTi04+kpThg0dB9EBAkEAiWIlUGra4M5q7u+FWbgtcJRKjMX6LIlsB1UiFHba<br>auSSQGwP+LMHVYDaWljzcPO<span class="hljs-regexp">/c5/</span>MZbIDmGCZsDeImvSdMQ==<br>-----<span class="hljs-keyword">END</span> RSA PRIVATE KEY-----<br></code></pre></td></tr></table></figure>

<ol start="2">
<li><code>PKCS1</code>和<code>PKCS8</code>互相转换</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> PKCS1私钥转换为PKCS8，java语言使用的是PKCS8<br>$ openssl pkcs8 -topk8 -inform PEM -<span class="hljs-keyword">in</span> <span class="hljs-regexp">/xx/</span>xx<span class="hljs-regexp">/private_pkcs1.pem -outform pem -nocrypt -out /</span>xx<span class="hljs-regexp">/xx/</span>private_pkcs8.pem<br><br><span class="hljs-regexp">//</span> PKCS8私钥转换为PKCS1<br>$ openssl rsa -<span class="hljs-keyword">in</span> <span class="hljs-regexp">/xx/</span>xx<span class="hljs-regexp">/private_pkcs8.pem -out /</span>xx<span class="hljs-regexp">/xx/</span>private_pkcs1.pem<br></code></pre></td></tr></table></figure>
<p>同样文件名之前为本地路径，生成到对应的路径下，生成的<code>PKCS8</code>格式私钥如下</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">-----<span class="hljs-keyword">BEGIN</span> PRIVATE KEY-----<br>MIICeAIBADANBgkqhkiG9w0BAQEFAASCAmIwggJeAgEAAoGBANZrqDk6A/IHnEKS<br><span class="hljs-number">8</span>QiK0DWAo4GhCLbWcBUkvuJUyqQDYyuGZSVmichOmoxbezJO1qSwy5qVq3UKaolF<br>BoOf5RV7S7ZaC2++<span class="hljs-number">7</span>wpoN1sNrpPKrpLYrz0YjaX8DOi4sTTp1pocOHeqO3A2YQOq<br>wruYRxI910gpog4dntsrM6RticYTAgMBAAECgYEAiI5jwp5qKNgj8lo226PcWlak<br>y0fNjvQeybhvQSGTNMVbgTrEa<span class="hljs-regexp">/9TvJgi4UTZvv5qwNQ/</span>tyGe4plRpD6rmWRZthwq<br>xJY5GAYFR5hQ5WhT1K5OnrmgUqRz0A61rHNVq9fnfpjVVG1P5vyYH76BnCnlxkdR<br>slOPgE9IofsglrAqyRECQQDuMDhz4jdl8UOSg6XjXHdy/Af7FAuLq+kvobDf+a4m<br>tzqa11lty5fCMxiVpz76Zc9NS3UrhvWxSYYberCeRSNfAkEA5nRvZ9mFGGwPM0WK<br>GcPU9cY2XnoVUbcbRpZnNAgdBfUMgT6wbiQInGurFOcdZz47Y4M9TY9slQ3R9ykS<br><span class="hljs-number">6</span>gNtzQJBAL0ulZgNQ<span class="hljs-regexp">/z3LLlxUNAOAF3WqiwVFrp/</span><span class="hljs-number">9306</span>irbKpDTh8W1MwB4Bx+<span class="hljs-number">6</span>a<br>ENvEc7QEKyv0VAMXdYuznw2yXBfJSDcCQGAYrVvgmF9Wr<span class="hljs-regexp">//</span>xP2T/BA54WLOMtNce<br>Q4Frth08RN33EP/T5D4JSI3xV6WfueMTUDBuyWFOLTj6SlOGDR0H0QECQQCJYiVQ<br>atrgzmru74VZuC1wlEqMxfosiWwHVSIUdtpq5JJAbA/<span class="hljs-number">4</span>swdVgNpaWPNw879zn8xl<br>sgOYYJmwN4ia9J0x<br>-----<span class="hljs-keyword">END</span> PRIVATE KEY-----<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>生成公钥</li>
</ol>
<p><code>RSA</code>公钥是由私钥中生成的，公钥不区分格式，<code>PKCS1</code>和<code>PKCS8</code>都能生成公钥，生成结果一致</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">$ openssl rsa -in <span class="hljs-regexp">/xx/</span>xx<span class="hljs-regexp">/private_pkcs1.pem -pubout -out /</span>xx<span class="hljs-regexp">/xx/</span><span class="hljs-keyword">public</span>.pem<br></code></pre></td></tr></table></figure>
<p>生成结果如下</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">-----BEGIN <span class="hljs-keyword">PUBLIC</span> <span class="hljs-keyword">KEY</span>-----<br>MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDWa6g5OgPyB5xCkvEIitA1gKOB<br>oQi21nAVJL7iVMqkA2MrhmUlZonITpqMW3syTtaksMualat1CmqJRQaDn+UVe0u2<br>Wgtvvu8KaDdbDa6Tyq6S2K89GI2l/AzouLE06daaHDh3qjtwNmEDqsK7mEcSPddI<br>KaIOHZ7bKzOkbYnGEwIDAQAB<br>-----<span class="hljs-keyword">END</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-keyword">KEY</span>-----<br></code></pre></td></tr></table></figure>

<blockquote>
<p>以上为生成<code>RSA</code>秘钥基本的操作，所有的秘钥文件均以<code>.pem</code>格式存在，可以直接使用文本编辑器读取其中的秘钥字符串，秘钥字符串为<code>Base64</code>格式，<code>Android</code>和<code>iOS</code>在使用时都可以直接使用文件或者字符串</p>
</blockquote>
<h5 id="2、iOS数字证书"><a href="#2、iOS数字证书" class="headerlink" title="2、iOS数字证书"></a>2、<code>iOS</code>数字证书</h5><p><code>.pem</code>格式文件已能正常使用，<code>iOS</code>系统也可以直接使用文件中的秘钥字符串，为了进一步保证安全性，<code>iOS</code>系统中可以对公钥和私钥进行进一步签名，做成数字证书的形式，<code>.der</code>格式文件存放，<code>.p12</code>格式的文件存放的是私钥，<code>.der</code>和<code>.p12</code>文件均为二进制文件，无法查看</p>
<ol>
<li>生成证书请求文件<code>.csr</code></li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">$ openssl req -<span class="hljs-keyword">new</span> -key <span class="hljs-regexp">/xxx/</span>xxx<span class="hljs-regexp">/private_pkcs1.pem -out /</span>xxx<span class="hljs-regexp">/xxx/</span>rsa_cert.csr<br></code></pre></td></tr></table></figure>
<p>这一步会提示输入国家、省份等信息，可酌情填写</p>
<ol start="2">
<li>生成证书<code>.crt</code>，并设置有效时间1年</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ openssl x509 -req -days <span class="hljs-number">365</span> -<span class="hljs-keyword">in</span> <span class="hljs-regexp">/xxx/</span>xxx<span class="hljs-regexp">/rsa_cert.csr -signkey /</span>xxx<span class="hljs-regexp">/xxx/</span>private_pkcs1.pem -out <span class="hljs-regexp">/xxx/</span>xxx/rsa_cert.crt<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>导出<code>iOS</code>使用的公钥文件<code>.der</code></li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">$ openssl x509 -outform der -in <span class="hljs-regexp">/xxx/</span>xxx<span class="hljs-regexp">/rsa_cert.crt -out /</span>xxx<span class="hljs-regexp">/xxx/</span><span class="hljs-keyword">public</span>.der<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>导出<code>iOS</code>使用的私钥文件<code>.p12</code></li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ openssl pkcs12 -export -out <span class="hljs-regexp">/xxx/</span>xxx<span class="hljs-regexp">/private.p12 -inkey /</span>xxx<span class="hljs-regexp">/xxx/</span>private_pkcs1.pem -<span class="hljs-keyword">in</span> <span class="hljs-regexp">/xxx/</span>xxx/rsa_cert.crt<br></code></pre></td></tr></table></figure>
<p>这一步会提示给私钥证书<code>.p12</code>设置证书密码，输入即可</p>
<h4 id="四、iOS代码"><a href="#四、iOS代码" class="headerlink" title="四、iOS代码"></a>四、<code>iOS</code>代码</h4><h5 id="1、OpenSSL开源库"><a href="#1、OpenSSL开源库" class="headerlink" title="1、OpenSSL开源库"></a>1、<code>OpenSSL</code>开源库</h5><p><a target="_blank" rel="noopener" href="https://github.com/"><code>github</code></a>上有<a target="_blank" rel="noopener" href="https://github.com/openssl/openssl"><code>OpenSSL</code></a>的开源代码，但是工程里面无法直接引入，此处推荐另一个开源代码<a target="_blank" rel="noopener" href="https://github.com/x2on/OpenSSL-for-iPhone"><code>OpenSSL-for-iPhone</code></a>，在<code>README</code>中作者提供了相关的编译方法</p>
<p><img src="image_1.png" srcset="/img/loading.gif" lazyload alt="image_1.png"></p>
<p>编译完成后，找到<code>OpenSSL-for-iPhone</code>工程里面编译成功的<code>.a</code>文件，<code>libcrypto.a</code>和<code>libssl.a</code>，还有文件夹<code>include</code></p>
<p><img src="image_2.png" srcset="/img/loading.gif" lazyload alt="image_2.png"></p>
<p>导入项目工程中，并把<code>include</code>文件夹添加到<code>Build Setting</code>中的<code>Header Search Paths</code>中，再检查<code>Library Search Paths</code>中是否能引用到<code>.a</code>文件，具体代码如下</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;openssl/rsa.h&gt;</span></span><br><br><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> : <span class="hljs-built_in">NSUInteger</span> &#123;<br>    OpenSSL_RSA_SignType_MD5,<br>    OpenSSL_RSA_SignType_SHA1,<br>    OpenSSL_RSA_SignType_SHA224,<br>    OpenSSL_RSA_SignType_SHA256,<br>    OpenSSL_RSA_SignType_SHA384,<br>    OpenSSL_RSA_SignType_SHA512,<br>&#125; OpenSSL_RSA_SignType;<br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">OpenSSLWrapper</span> : <span class="hljs-title">NSObject</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 生成一对秘钥</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> @param keySize 512、1024、2048</span><br><span class="hljs-comment"> @param publicKey 公钥内存地址</span><br><span class="hljs-comment"> @param privateKey 私钥内存地址</span><br><span class="hljs-comment"> @return 是否成功生成</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">BOOL</span>)generateKeyPairWithKeySize:(<span class="hljs-keyword">int</span>)keySize publicKey:(RSA *_Nullable*_Nullable)publicKey privateKey:(RSA *_Nullable*_Nullable)privateKey;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥加密</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> @param publicKey 公钥</span><br><span class="hljs-comment"> @param plainString 源数据</span><br><span class="hljs-comment"> @return 加密后数据</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">NSString</span> *)opensslEncryptWithPublicKey:(RSA *)publicKey plainString:(<span class="hljs-built_in">NSString</span> *)plainString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥解密</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> @param privateKey 私钥</span><br><span class="hljs-comment"> @param encryptString 加密后数据</span><br><span class="hljs-comment"> @return 源数据</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">NSString</span> *)opensslDecryptWithPrivateKey:(RSA *)privateKey encryptString:(<span class="hljs-built_in">NSString</span> *)encryptString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥签名</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> @param privateKey 私钥</span><br><span class="hljs-comment"> @param signType 签名算法</span><br><span class="hljs-comment"> @param plainString 源数据</span><br><span class="hljs-comment"> @return 签名后数据</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">NSString</span> *)signWithPrivateKey:(RSA *)privateKey signType:(OpenSSL_RSA_SignType)signType plainString:(<span class="hljs-built_in">NSString</span> *)plainString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥验证签名</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> @param publicKey 公钥</span><br><span class="hljs-comment"> @param signType 签名算法</span><br><span class="hljs-comment"> @param plainString 源数据</span><br><span class="hljs-comment"> @param signString 签名后数据</span><br><span class="hljs-comment"> @return 是否验证成功</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">BOOL</span>)verifyWithPublicKey:(RSA *)publicKey signType:(OpenSSL_RSA_SignType)signType plainString:(<span class="hljs-built_in">NSString</span> *)plainString signString:(<span class="hljs-built_in">NSString</span> *)signString;<br><br><span class="hljs-comment">// RSA转base64</span><br>+ (<span class="hljs-built_in">NSString</span> *)base64StringFromPublicRSAKey:(RSA *)rsaKey;<br>+ (<span class="hljs-built_in">NSString</span> *)base64StringFromPrivateRSAKey:(RSA *)rsaKey;<br><span class="hljs-comment">// base64转RSA秘钥</span><br>+ (RSA *)publicRSAKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString;<br>+ (RSA *)privateRSAKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-built_in">NS_ASSUME_NONNULL_END</span><br></code></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;OpenSSLWrapper.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;openssl/pem.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;CommonCrypto/CommonCrypto.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">OpenSSLWrapper</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 生成一对秘钥</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">BOOL</span>)generateKeyPairWithKeySize:(<span class="hljs-keyword">int</span>)keySize publicKey:(RSA *_Nullable*_Nullable)publicKey privateKey:(RSA *_Nullable*_Nullable)privateKey &#123;<br>    <span class="hljs-keyword">if</span> (keySize == <span class="hljs-number">512</span> || keySize == <span class="hljs-number">1024</span> || keySize == <span class="hljs-number">2048</span>) &#123;<br>        RSA *rsa = RSA_generate_key(keySize, RSA_F4, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-keyword">if</span> (rsa) &#123;<br>            *privateKey = RSAPrivateKey_dup(rsa);<br>            *publicKey = RSAPublicKey_dup(rsa);<br>            <span class="hljs-keyword">if</span> (*privateKey &amp;&amp; *publicKey) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥加密</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">NSString</span> *)opensslEncryptWithPublicKey:(RSA *)publicKey plainString:(<span class="hljs-built_in">NSString</span> *)plainString &#123;<br>    <span class="hljs-comment">// 参数转data</span><br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    <span class="hljs-built_in">NSMutableData</span> *encryptData = [<span class="hljs-built_in">NSMutableData</span> data];<br>    <span class="hljs-comment">// 分段加密，计算分段长度</span><br>    <span class="hljs-keyword">int</span> cipherBufferSize = RSA_size(publicKey);<br>    <span class="hljs-built_in">NSUInteger</span> totalSize = plainData.length;<br>    <br>    <span class="hljs-keyword">int</span> blockSize = cipherBufferSize - RSA_PKCS1_PADDING_SIZE;<br>    <span class="hljs-keyword">int</span> blockCount = ceil(totalSize * <span class="hljs-number">1.</span>f / blockSize);<br>    <br>    <span class="hljs-comment">// 遍历获取每个分段数据</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; blockCount; i++) &#123;<br>        <span class="hljs-comment">// 取出当前分段数据</span><br>        <span class="hljs-built_in">NSData</span> *blockData;<br>        <span class="hljs-keyword">if</span> (i &lt; (blockCount - <span class="hljs-number">1</span>)) &#123;<br>            blockData = [plainData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, blockSize)];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            blockData = [plainData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, totalSize - i * blockSize)];<br>        &#125;<br>        <span class="hljs-comment">// 申请对应内存，公钥长度</span><br>        uint8_t *cipherBuffer = malloc(cipherBufferSize * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>        memset((<span class="hljs-keyword">void</span> *)cipherBuffer, <span class="hljs-number">0x0</span>, cipherBufferSize);<br>        <span class="hljs-comment">// 加密当前分段数据</span><br>        <span class="hljs-keyword">int</span> result = RSA_public_encrypt((<span class="hljs-keyword">int</span>)blockData.length, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)blockData.bytes, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)cipherBuffer, publicKey, RSA_PKCS1_PADDING);<br>        <span class="hljs-keyword">if</span> (result &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 加密失败，释放内存</span><br>            <span class="hljs-keyword">if</span> (cipherBuffer) &#123;<br>                free(cipherBuffer);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>        <span class="hljs-built_in">NSData</span> *cipher = [[<span class="hljs-built_in">NSData</span> alloc] initWithBytes:cipherBuffer length:result];<br>        [encryptData appendData:cipher];<br>        <span class="hljs-keyword">if</span> (cipherBuffer) &#123;<br>            free(cipherBuffer);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 转base64</span><br>    <span class="hljs-built_in">NSString</span> *encryptString = [encryptData base64EncodedStringWithOptions:<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">return</span> encryptString;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥解密</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">NSString</span> *)opensslDecryptWithPrivateKey:(RSA *)privateKey encryptString:(<span class="hljs-built_in">NSString</span> *)encryptString &#123;<br>    <span class="hljs-comment">// 参数转data</span><br>    <span class="hljs-built_in">NSData</span> *encryptData = [[<span class="hljs-built_in">NSData</span> alloc] initWithBase64EncodedString:encryptString options:<span class="hljs-built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>];<br>    <span class="hljs-built_in">NSMutableData</span> *outputPlainData = [<span class="hljs-built_in">NSMutableData</span> data];<br>    <span class="hljs-comment">// 分段解密，计算分段长度</span><br>    <span class="hljs-keyword">int</span> cipherBufferSize = RSA_size(privateKey);<br>    <span class="hljs-built_in">NSUInteger</span> totalSize = encryptData.length;<br>    <br>    <span class="hljs-keyword">int</span> blockSize = cipherBufferSize;<br>    <span class="hljs-keyword">int</span> blockCount = ceil(totalSize * <span class="hljs-number">1.</span>f / blockSize);<br>    <br>    <span class="hljs-comment">// 遍历获取每个分段数据</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; blockCount; i++) &#123;<br>        <span class="hljs-comment">// 取出当前分段数据</span><br>        <span class="hljs-built_in">NSData</span> *blockData;<br>        <span class="hljs-keyword">if</span> (i &lt; (blockCount - <span class="hljs-number">1</span>)) &#123;<br>            blockData = [encryptData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, blockSize)];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            blockData = [encryptData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, totalSize - i * blockSize)];<br>        &#125;<br>        <span class="hljs-comment">// 申请对应内存</span><br>        uint8_t *keyBuffer = malloc(cipherBufferSize * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>        memset((<span class="hljs-keyword">void</span> *)keyBuffer, <span class="hljs-number">0x0</span>, cipherBufferSize);<br>        <span class="hljs-comment">// 解密当前分段数据</span><br>        <span class="hljs-keyword">int</span> result = RSA_private_decrypt(cipherBufferSize, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)blockData.bytes, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)keyBuffer, privateKey, RSA_PKCS1_PADDING);<br>        <span class="hljs-keyword">if</span> (result &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 解密失败，释放内存</span><br>            <span class="hljs-keyword">if</span> (keyBuffer) &#123;<br>                free(keyBuffer);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>        <span class="hljs-built_in">NSData</span> *key = [[<span class="hljs-built_in">NSData</span> alloc] initWithBytes:keyBuffer length:result];<br>        [outputPlainData appendData:key];<br>        <span class="hljs-keyword">if</span> (keyBuffer) &#123;<br>            free(keyBuffer);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">NSString</span> *outputPlainString = [[<span class="hljs-built_in">NSString</span> alloc] initWithData:outputPlainData encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    <span class="hljs-keyword">return</span> outputPlainString;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥签名</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">NSString</span> *)signWithPrivateKey:(RSA *)privateKey signType:(OpenSSL_RSA_SignType)signType plainString:(<span class="hljs-built_in">NSString</span> *)plainString &#123;<br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:(<span class="hljs-built_in">NSUTF8StringEncoding</span>)];<br>    <br>    <span class="hljs-keyword">int</span> type;<br>    <span class="hljs-built_in">NSData</span> *digestData = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">switch</span> (signType) &#123;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_MD5:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_MD5_DIGEST_LENGTH];<br>            CC_MD5([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_MD5_DIGEST_LENGTH];<br>            type = NID_md5;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA1:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA1_DIGEST_LENGTH];<br>            CC_SHA1([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA1_DIGEST_LENGTH];<br>            type = NID_sha1;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA224:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA224_DIGEST_LENGTH];<br>            CC_SHA224([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA224_DIGEST_LENGTH];<br>            type = NID_sha224;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA256:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA256_DIGEST_LENGTH];<br>            CC_SHA256([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA256_DIGEST_LENGTH];<br>            type = NID_sha256;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA384:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA384_DIGEST_LENGTH];<br>            CC_SHA384([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA384_DIGEST_LENGTH];<br>            type = NID_sha384;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA512:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA512_DIGEST_LENGTH];<br>            CC_SHA512([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA512_DIGEST_LENGTH];<br>            type = NID_sha512;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (digestData) &#123;<br>        <span class="hljs-keyword">int</span> signedHashBytesSize = RSA_size(privateKey);<br>        <br>        uint8_t *signedHashBytes = malloc(signedHashBytesSize * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>        memset((<span class="hljs-keyword">void</span> *)signedHashBytes, <span class="hljs-number">0x0</span>, signedHashBytesSize);<br>        <br>        <br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> siglen = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">int</span> result = RSA_sign(type, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)digestData.bytes, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)digestData.length, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)signedHashBytes, &amp;siglen, privateKey);<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-built_in">NSData</span> *signedHash = [<span class="hljs-built_in">NSData</span> dataWithBytes:signedHashBytes length:siglen];<br>            <span class="hljs-keyword">if</span> (signedHashBytes) &#123;<br>                free(signedHashBytes);<br>            &#125;<br>            <span class="hljs-built_in">NSString</span> *signString = [signedHash base64EncodedStringWithOptions:<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">return</span> signString;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (signedHashBytes) &#123;<br>            free(signedHashBytes);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥验证签名</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">BOOL</span>)verifyWithPublicKey:(RSA *)publicKey signType:(OpenSSL_RSA_SignType)signType plainString:(<span class="hljs-built_in">NSString</span> *)plainString signString:(<span class="hljs-built_in">NSString</span> *)signString &#123;<br>    <br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:(<span class="hljs-built_in">NSUTF8StringEncoding</span>)];<br>    <span class="hljs-built_in">NSData</span> *signData = [[<span class="hljs-built_in">NSData</span> alloc] initWithBase64EncodedString:signString options:<span class="hljs-built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>];<br>    <br>    <span class="hljs-keyword">int</span> type;<br>    <span class="hljs-built_in">NSData</span> *digestData = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">switch</span> (signType) &#123;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_MD5:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_MD5_DIGEST_LENGTH];<br>            CC_MD5([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_MD5_DIGEST_LENGTH];<br>            type = NID_md5;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA1:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA1_DIGEST_LENGTH];<br>            CC_SHA1([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA1_DIGEST_LENGTH];<br>            type = NID_sha1;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA224:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA224_DIGEST_LENGTH];<br>            CC_SHA224([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA224_DIGEST_LENGTH];<br>            type = NID_sha224;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA256:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA256_DIGEST_LENGTH];<br>            CC_SHA256([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA256_DIGEST_LENGTH];<br>            type = NID_sha256;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA384:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA384_DIGEST_LENGTH];<br>            CC_SHA384([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA384_DIGEST_LENGTH];<br>            type = NID_sha384;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> OpenSSL_RSA_SignType_SHA512:<br>        &#123;<br>            <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> digest[CC_SHA512_DIGEST_LENGTH];<br>            CC_SHA512([plainData bytes], (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)[plainData length], digest);<br>            digestData = [<span class="hljs-built_in">NSData</span> dataWithBytes:digest length:CC_SHA512_DIGEST_LENGTH];<br>            type = NID_sha512;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (digestData) &#123;<br>        <span class="hljs-keyword">int</span> result = RSA_verify(type, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)digestData.bytes, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)digestData.length, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)signData.bytes, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)signData.length, publicKey);<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> RSA转base64</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-built_in">NSString</span> *)base64StringFromPublicRSAKey:(RSA *)rsaKey &#123;<br>    BIO *bio = BIO_new(BIO_s_mem());<br>    PEM_write_bio_RSA_PUBKEY(bio, rsaKey);<br>    BUF_MEM *buf;<br>    BIO_get_mem_ptr(bio, &amp;buf);<br>    <span class="hljs-comment">// data 后面可能会有有脏数据</span><br>    <span class="hljs-built_in">NSString</span> *pemString = [[<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%s&quot;</span>, buf-&gt;data] substringToIndex:buf-&gt;length];<br>    BIO_set_close(bio, BIO_NOCLOSE);<br>    BIO_free(bio);<br>    <span class="hljs-built_in">NSString</span> *base64 = [[pemString componentsSeparatedByString:<span class="hljs-string">@&quot;-----&quot;</span>] objectAtIndex:<span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">return</span> base64;<br>&#125;<br>+ (<span class="hljs-built_in">NSString</span> *)base64StringFromPrivateRSAKey:(RSA *)rsaKey &#123;<br>    BIO *bio = BIO_new(BIO_s_mem());<br>    PEM_write_bio_RSAPrivateKey(bio, rsaKey, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    BUF_MEM *buf;<br>    BIO_get_mem_ptr(bio, &amp;buf);<br>    <span class="hljs-comment">// data 后面可能会有有脏数据</span><br>    <span class="hljs-built_in">NSString</span> *pemString = [[<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;%s&quot;</span>, buf-&gt;data] substringToIndex:buf-&gt;length];<br>    BIO_set_close(bio, BIO_NOCLOSE);<br>    BIO_free(bio);<br>    <span class="hljs-built_in">NSString</span> *base64 = [[pemString componentsSeparatedByString:<span class="hljs-string">@&quot;-----&quot;</span>] objectAtIndex:<span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">return</span> base64;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> base64转RSA秘钥</span><br><span class="hljs-comment"> */</span><br>+ (RSA *)publicRSAKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString &#123;<br>    <span class="hljs-built_in">NSMutableString</span> *result = [<span class="hljs-built_in">NSMutableString</span> string];<br>    [result appendString:<span class="hljs-string">@&quot;-----BEGIN PUBLIC KEY-----\n&quot;</span>];<br>    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; keyString.length; i++) &#123;<br>        <span class="hljs-keyword">unichar</span> c = [keyString characterAtIndex:i];<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;\n&#x27;</span> || c == <span class="hljs-string">&#x27;\r&#x27;</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        [result appendFormat:<span class="hljs-string">@&quot;%c&quot;</span>, c];<br>        count++;<br>        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">64</span>) &#123;<br>            [result appendString:<span class="hljs-string">@&quot;\n&quot;</span>];<br>            count = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    [result appendString:<span class="hljs-string">@&quot;\n-----END PUBLIC KEY-----&quot;</span>];<br>    <br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *buffer = [result UTF8String];<br>    BIO *bio = BIO_new_mem_buf(buffer, (<span class="hljs-keyword">int</span>)strlen(buffer));<br>    RSA *publicKey = PEM_read_bio_RSA_PUBKEY(bio, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    BIO_free_all(bio);<br>    <span class="hljs-keyword">return</span> publicKey;<br>&#125;<br><br>+ (RSA *)privateRSAKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString &#123;<br>    <span class="hljs-built_in">NSMutableString</span> *result = [<span class="hljs-built_in">NSMutableString</span> string];<br>    [result appendString:<span class="hljs-string">@&quot;-----BEGIN RSA PRIVATE KEY-----\n&quot;</span>];<br>    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; keyString.length; i++) &#123;<br>        <span class="hljs-keyword">unichar</span> c = [keyString characterAtIndex:i];<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;\n&#x27;</span> || c == <span class="hljs-string">&#x27;\r&#x27;</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        [result appendFormat:<span class="hljs-string">@&quot;%c&quot;</span>, c];<br>        count++;<br>        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">64</span>) &#123;<br>            [result appendString:<span class="hljs-string">@&quot;\n&quot;</span>];<br>            count = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    [result appendString:<span class="hljs-string">@&quot;\n-----END RSA PRIVATE KEY-----&quot;</span>];<br>    <br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *buffer = [result UTF8String];<br>    BIO *bio = BIO_new_mem_buf(buffer, (<span class="hljs-keyword">int</span>)strlen(buffer));<br>    RSA *privateKey = PEM_read_bio_RSAPrivateKey(bio, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    BIO_free_all(bio);<br>    <span class="hljs-keyword">return</span> privateKey;<br>&#125;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<p>方法调用示例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;ViewController.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;OpenSSLWrapper.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> () </span>&#123;<br>    RSA *_publicKey;<br>    RSA *_privateKey;<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-keyword">super</span> viewDidLoad];<br>    <span class="hljs-comment">// Do any additional setup after loading the view.</span><br>    <br>    _publicKey = <span class="hljs-literal">NULL</span>;<br>    _privateKey = <span class="hljs-literal">NULL</span>;<br>    [OpenSSLWrapper generateKeyPairWithKeySize:<span class="hljs-number">1024</span> publicKey:&amp;_publicKey privateKey:&amp;_privateKey];<br>    <span class="hljs-built_in">NSString</span> *publicKeyBase64 = [OpenSSLWrapper base64StringFromPublicRSAKey:_publicKey];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;公钥：%@&quot;</span>, publicKeyBase64);<br>    <span class="hljs-built_in">NSString</span> *privateKeyBase64 = [OpenSSLWrapper base64StringFromPrivateRSAKey:_privateKey];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;私钥：%@&quot;</span>, privateKeyBase64);<br><br>    <span class="hljs-built_in">NSString</span> *plainString = <span class="hljs-string">@&quot;123qweQWE测试@#%&amp;*&quot;</span>;<br><br>    <span class="hljs-built_in">NSString</span> *encryptedString = [OpenSSLWrapper opensslEncryptWithPublicKey:_publicKey plainString:plainString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;公钥加密：%@&quot;</span>, encryptedString]);<br><br>    <span class="hljs-built_in">NSString</span> *outputPlainString = [OpenSSLWrapper opensslDecryptWithPrivateKey:_privateKey encryptString:encryptedString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;私钥解密：%@&quot;</span>, outputPlainString]);<br><br>    <span class="hljs-built_in">NSString</span> *signString = [OpenSSLWrapper signWithPrivateKey:_privateKey signType:(OpenSSL_RSA_SignType_SHA1) plainString:plainString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;私钥签名：%@&quot;</span>, signString]);<br><br>    <span class="hljs-built_in">BOOL</span> verify = [OpenSSLWrapper verifyWithPublicKey:_publicKey signType:(OpenSSL_RSA_SignType_SHA1) plainString:plainString signString:signString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;验证 %@&quot;</span>, verify ? <span class="hljs-string">@&quot;通过&quot;</span> : <span class="hljs-string">@&quot;不通过&quot;</span>]);<br>&#125;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<h5 id="2、苹果官方Security库"><a href="#2、苹果官方Security库" class="headerlink" title="2、苹果官方Security库"></a>2、苹果官方<code>Security</code>库</h5><p>苹果官方<code>Security</code>库也集成了相应的方法，在<code>iOS 2</code>中便已经提供，官网也提供了调用示例代码，苹果系统打包和发布均采用了<code>RSA</code>的操作</p>
<blockquote>
<div style="color: red;">注：部分新的方法在`iOS 10.0`系统后提供</div>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;Security/Security.h&gt;</span></span><br><br><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SecKeyWrapper</span> : <span class="hljs-title">NSObject</span> &lt;<span class="hljs-title">NSCopying</span>, <span class="hljs-title">NSMutableCopying</span>&gt;</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 单例方法</span><br><span class="hljs-comment"> */</span><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 生成秘钥</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> @param keySize 512、1024、2048</span><br><span class="hljs-comment"> @param publicKeyRef 公钥内存地址</span><br><span class="hljs-comment"> @param privateKeyRef 公钥内存地址</span><br><span class="hljs-comment"> @return 是否成功生成</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">BOOL</span>)generateKeyPair:(<span class="hljs-built_in">NSUInteger</span>)keySize publicKey:(SecKeyRef _Nullable *_Nonnull)publicKeyRef privateKey:(SecKeyRef _Nullable *_Nonnull)privateKeyRef;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥加密</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param publicKey 公钥</span><br><span class="hljs-comment"> @param plainString 源数据</span><br><span class="hljs-comment"> @return 加密后数据</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">NSString</span> *)secKeyEncryptWithPublicKey:(SecKeyRef)publicKey plainString:(<span class="hljs-built_in">NSString</span> *)plainString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥解密</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param privateKey 私钥</span><br><span class="hljs-comment"> @param encryptString 加密后数据</span><br><span class="hljs-comment"> @return 源数据</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">NSString</span> *)secKeyDecryptWithPrivateKey:(SecKeyRef)privateKey encryptString:(<span class="hljs-built_in">NSString</span> *)encryptString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥签名</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param privateKey 私钥</span><br><span class="hljs-comment"> @param secPadding 算法类型</span><br><span class="hljs-comment"> @param plainString 源数据</span><br><span class="hljs-comment"> @return 签名后数据</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">NSString</span> *)signWithPrivateSecKey:(SecKeyRef)privateKey secPadding:(SecPadding)secPadding plainString:(<span class="hljs-built_in">NSString</span> *)plainString;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥验证签名</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment"> @param publicKey 公钥</span><br><span class="hljs-comment"> @param secPadding 算法类型</span><br><span class="hljs-comment"> @param plainString 源数据</span><br><span class="hljs-comment"> @param signString 签名后数据</span><br><span class="hljs-comment"> @return 是否验证成功</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">BOOL</span>)verifyWithPublicSecKey:(SecKeyRef)publicKey secPadding:(SecPadding)secPadding plainString:(<span class="hljs-built_in">NSString</span> *)plainString signString:(<span class="hljs-built_in">NSString</span> *)signString;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_10_0</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> SecKeyRef转base64</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">NSString</span> *)base64StringFromSecKey:(SecKeyRef)secKey;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> base64转SecKeyRef</span><br><span class="hljs-comment"> */</span><br>- (SecKeyRef)publicSecKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString;<br>- (SecKeyRef)privateSecKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-built_in">NS_ASSUME_NONNULL_END</span><br></code></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;SecKeyWrapper.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;CommonCrypto/CommonDigest.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;CommonCrypto/CommonCryptor.h&gt;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;Security/SecKey.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">SecKeyWrapper</span> () </span>&#123;<br>    <span class="hljs-built_in">NSData</span> *_publicTag;<br>    <span class="hljs-built_in">NSData</span> *_privateTag;<br>&#125;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">SecKeyWrapper</span></span><br><br><span class="hljs-keyword">static</span> SecKeyWrapper *instance = <span class="hljs-literal">nil</span>;<br><br><br>+ (<span class="hljs-keyword">instancetype</span>)shareInstance &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">dispatch_once_t</span> onceToken;<br>    <span class="hljs-built_in">dispatch_once</span>(&amp;onceToken, ^&#123;<br>        instance = [[<span class="hljs-keyword">super</span> allocWithZone:<span class="hljs-literal">NULL</span>] init];<br>    &#125;);<br>    <span class="hljs-keyword">return</span> instance;<br>&#125;<br><br>- (<span class="hljs-keyword">instancetype</span>)init &#123;<br>    <span class="hljs-keyword">self</span> = [<span class="hljs-keyword">super</span> init];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) &#123;<br>        <span class="hljs-comment">// 单例的内部逻辑</span><br>        <span class="hljs-comment">// 初始化tag标记，此字符串长度固定，内容可更改</span><br>        _privateTag = [<span class="hljs-string">@&quot;com.ghtest.rsasecprivatekey&quot;</span> dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>        _publicTag = [<span class="hljs-string">@&quot;com.ghtest.rsasecpublickey&quot;</span> dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>        <br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;<br>&#125;<br><br>+ (<span class="hljs-keyword">instancetype</span>)allocWithZone:(<span class="hljs-keyword">struct</span> _NSZone *)zone &#123;<br>    <span class="hljs-keyword">return</span> [SecKeyWrapper shareInstance];<br>&#125;<br><br>- (<span class="hljs-keyword">id</span>)copyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone &#123;<br>    <span class="hljs-keyword">return</span> [SecKeyWrapper shareInstance];<br>&#125;<br><br>- (<span class="hljs-keyword">id</span>)mutableCopyWithZone:(<span class="hljs-built_in">NSZone</span> *)zone &#123;<br>    <span class="hljs-keyword">return</span> [SecKeyWrapper shareInstance];<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 生成秘钥</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">BOOL</span>)generateKeyPair:(<span class="hljs-built_in">NSUInteger</span>)keySize publicKey:(SecKeyRef _Nullable *_Nonnull)publicKeyRef privateKey:(SecKeyRef _Nullable *_Nonnull)privateKeyRef &#123;<br>    <br>    <span class="hljs-keyword">if</span> (keySize == <span class="hljs-number">512</span> || keySize == <span class="hljs-number">1024</span> || keySize == <span class="hljs-number">2048</span>) &#123;<br>        <span class="hljs-comment">// 首先删除旧的秘钥</span><br>        OSStatus sanityCheck = noErr;<br>        <span class="hljs-built_in">NSMutableDictionary</span> *queryPublicKey = [[<span class="hljs-built_in">NSMutableDictionary</span> alloc] init];<br>        <span class="hljs-built_in">NSMutableDictionary</span> *queryPrivateKey = [[<span class="hljs-built_in">NSMutableDictionary</span> alloc] init];<br>        <span class="hljs-comment">// 设置公钥队列</span><br>        [queryPublicKey setObject:(<span class="hljs-keyword">id</span>)kSecClassKey forKey:(<span class="hljs-keyword">id</span>)kSecClass];<br>        [queryPublicKey setObject:_publicTag forKey:(<span class="hljs-keyword">id</span>)kSecAttrApplicationTag];<br>        [queryPublicKey setObject:(<span class="hljs-keyword">id</span>)kSecAttrKeyTypeRSA forKey:(<span class="hljs-keyword">id</span>)kSecAttrKeyType];<br>        <span class="hljs-comment">// 设置私钥队列</span><br>        [queryPrivateKey setObject:(<span class="hljs-keyword">id</span>)kSecClassKey forKey:(<span class="hljs-keyword">id</span>)kSecClass];<br>        [queryPrivateKey setObject:_privateTag forKey:(<span class="hljs-keyword">id</span>)kSecAttrApplicationTag];<br>        [queryPrivateKey setObject:(<span class="hljs-keyword">id</span>)kSecAttrKeyTypeRSA forKey:(<span class="hljs-keyword">id</span>)kSecAttrKeyType];<br>        <br>        <span class="hljs-comment">// 删除私钥</span><br>        sanityCheck = SecItemDelete((<span class="hljs-built_in">CFDictionaryRef</span>)queryPrivateKey);<br>        <span class="hljs-keyword">if</span> (sanityCheck == noErr || sanityCheck == errSecItemNotFound) &#123;<br>            <br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Error removing private key, OSStatus == %d.&quot;</span>, sanityCheck);<br>        &#125;<br>        <span class="hljs-comment">// 删除公钥</span><br>        sanityCheck = SecItemDelete((<span class="hljs-built_in">CFDictionaryRef</span>)queryPublicKey);<br>        <span class="hljs-keyword">if</span> (sanityCheck == noErr || sanityCheck == errSecItemNotFound) &#123;<br>            <br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Error removing public key, OSStatus == %d.&quot;</span>, sanityCheck);<br>        &#125;<br>        <br>        <span class="hljs-comment">// Container dictionaries.</span><br>        <span class="hljs-built_in">NSMutableDictionary</span> *keyPairAttr = [[<span class="hljs-built_in">NSMutableDictionary</span> alloc] init];<br>        <span class="hljs-built_in">NSMutableDictionary</span> *publicKeyAttr = [[<span class="hljs-built_in">NSMutableDictionary</span> alloc] init];<br>        <span class="hljs-built_in">NSMutableDictionary</span> *privateKeyAttr = [[<span class="hljs-built_in">NSMutableDictionary</span> alloc] init];<br>        <span class="hljs-comment">// Set top level dictionary for the keypair.</span><br>        [keyPairAttr setObject:(<span class="hljs-keyword">id</span>)kSecAttrKeyTypeRSA forKey:(<span class="hljs-keyword">id</span>)kSecAttrKeyType];<br>        [keyPairAttr setObject:[<span class="hljs-built_in">NSNumber</span> numberWithUnsignedInteger:keySize] forKey:(<span class="hljs-keyword">id</span>)kSecAttrKeySizeInBits];<br>        <span class="hljs-comment">// 公钥字典，其他参数SecKey.h</span><br>        [publicKeyAttr setObject:[<span class="hljs-built_in">NSNumber</span> numberWithBool:<span class="hljs-literal">YES</span>] forKey:(<span class="hljs-keyword">id</span>)kSecAttrIsPermanent];<br>        [publicKeyAttr setObject:_publicTag forKey:(<span class="hljs-keyword">id</span>)kSecAttrApplicationTag];<br>        <span class="hljs-comment">// 私钥字典，其他参数SecKey.h</span><br>        [privateKeyAttr setObject:[<span class="hljs-built_in">NSNumber</span> numberWithBool:<span class="hljs-literal">YES</span>] forKey:(<span class="hljs-keyword">id</span>)kSecAttrIsPermanent];<br>        [privateKeyAttr setObject:_privateTag forKey:(<span class="hljs-keyword">id</span>)kSecAttrApplicationTag];<br>        <span class="hljs-comment">// Set attributes to top level dictionary.</span><br>        [keyPairAttr setObject:publicKeyAttr forKey:(<span class="hljs-keyword">id</span>)kSecPublicKeyAttrs];<br>        [keyPairAttr setObject:privateKeyAttr forKey:(<span class="hljs-keyword">id</span>)kSecPrivateKeyAttrs];<br>        <br>        <span class="hljs-comment">// 同步方法生成秘钥</span><br>        OSStatus status = noErr;<br>        status = SecKeyGeneratePair((<span class="hljs-built_in">CFDictionaryRef</span>)keyPairAttr, publicKeyRef, privateKeyRef);<br>        <span class="hljs-keyword">if</span> (status == noErr &amp;&amp; publicKeyRef != <span class="hljs-literal">NULL</span> &amp;&amp; privateKeyRef != <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;Something really bad went wrong with generating the key pair.&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥加密</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">NSString</span> *)secKeyEncryptWithPublicKey:(SecKeyRef)publicKey plainString:(<span class="hljs-built_in">NSString</span> *)plainString &#123;<br>    <span class="hljs-comment">// 原数据</span><br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    <span class="hljs-built_in">NSMutableData</span> *encryptData = [<span class="hljs-built_in">NSMutableData</span> data];<br>    <span class="hljs-comment">// 循环分段加密，每次最多加密公钥长度，其中还需要kSecPaddingPKCS1填充，-11位</span><br>    size_t cipherBufferSize = SecKeyGetBlockSize(publicKey);<br>    <span class="hljs-built_in">NSUInteger</span> totalSize = plainData.length;<br>    <span class="hljs-comment">// 分段数量</span><br>    <span class="hljs-built_in">NSUInteger</span> blockSize = cipherBufferSize - <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">double</span> blockCount = ceil(totalSize * <span class="hljs-number">1.</span>f / blockSize);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSInteger</span> i = <span class="hljs-number">0</span>; i &lt; blockCount; i++) &#123;<br>        <span class="hljs-comment">// 取出当前分段数据</span><br>        <span class="hljs-built_in">NSData</span> *blockData;<br>        <span class="hljs-keyword">if</span> (i &lt; (blockCount - <span class="hljs-number">1</span>)) &#123;<br>            blockData = [plainData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, blockSize)];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            blockData = [plainData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, totalSize - i * blockSize)];<br>        &#125;<br>        <span class="hljs-comment">// 申请缓冲区内存，使用公钥长度申请</span><br>        uint8_t *cipherBuffer = malloc(cipherBufferSize * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>        memset((<span class="hljs-keyword">void</span> *)cipherBuffer, <span class="hljs-number">0x0</span>, cipherBufferSize);<br>        <span class="hljs-comment">// 加密</span><br>        OSStatus sanityCheck = noErr;<br>        sanityCheck = SecKeyEncrypt(publicKey, kSecPaddingPKCS1, (<span class="hljs-keyword">const</span> uint8_t *)[blockData bytes], [blockData length], cipherBuffer, &amp;cipherBufferSize);<br>        <span class="hljs-keyword">if</span> (sanityCheck == noErr) &#123;<br>            <span class="hljs-comment">// Build up cipher text blob.</span><br>            <span class="hljs-built_in">NSData</span> *cipher = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)cipherBuffer length:(<span class="hljs-built_in">NSUInteger</span>)cipherBufferSize];<br>            [encryptData appendData:cipher];<br>            <span class="hljs-keyword">if</span> (cipherBuffer) &#123;<br>                free(cipherBuffer);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 加密失败</span><br>            <span class="hljs-keyword">if</span> (cipherBuffer) &#123;<br>                free(cipherBuffer);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 转base64</span><br>    <span class="hljs-built_in">NSString</span> *encryptString = [encryptData base64EncodedStringWithOptions:<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">return</span> encryptString;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥解密</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">NSString</span> *)secKeyDecryptWithPrivateKey:(SecKeyRef)privateKey encryptString:(<span class="hljs-built_in">NSString</span> *)encryptString &#123;<br>    <span class="hljs-comment">// 原数据</span><br>    <span class="hljs-built_in">NSData</span> *encryptData = [[<span class="hljs-built_in">NSData</span> alloc] initWithBase64EncodedString:encryptString options:<span class="hljs-built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>];<br>    <span class="hljs-built_in">NSMutableData</span> *outputPlainData = [<span class="hljs-built_in">NSMutableData</span> data];<br>    <span class="hljs-comment">// 循环分段解密，每次最多解密私钥长度</span><br>    size_t cipherBufferSize = SecKeyGetBlockSize(privateKey);<br>    <span class="hljs-built_in">NSUInteger</span> totalSize = encryptData.length;<br>    <span class="hljs-comment">// 分段数量</span><br>    <span class="hljs-built_in">NSUInteger</span> blockSize = cipherBufferSize;<br>    <span class="hljs-keyword">double</span> blockCount = ceil(totalSize * <span class="hljs-number">1.</span>f / cipherBufferSize);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; blockCount; i++) &#123;<br>        <span class="hljs-comment">// 取出当前分段数据</span><br>        <span class="hljs-built_in">NSData</span> *blockData;<br>        <span class="hljs-keyword">if</span> (i &lt; (blockCount - <span class="hljs-number">1</span>)) &#123;<br>            blockData = [encryptData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, blockSize)];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            blockData = [encryptData subdataWithRange:<span class="hljs-built_in">NSMakeRange</span>(i * blockSize, totalSize - i * blockSize)];<br>        &#125;<br>        <span class="hljs-comment">// 申请当前分段加密占用内存</span><br>        uint8_t *keyBuffer = malloc(cipherBufferSize * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>        memset((<span class="hljs-keyword">void</span> *)keyBuffer, <span class="hljs-number">0x0</span>, cipherBufferSize);<br>        <span class="hljs-comment">// 解密</span><br>        OSStatus status = noErr;<br>        status = SecKeyDecrypt(privateKey, kSecPaddingPKCS1, (<span class="hljs-keyword">const</span> uint8_t *)[blockData bytes], [blockData length], keyBuffer, &amp;cipherBufferSize);<br>        <span class="hljs-keyword">if</span> (status == noErr) &#123;<br>            <span class="hljs-built_in">NSData</span> *key = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)keyBuffer length:(<span class="hljs-built_in">NSUInteger</span>)cipherBufferSize];<br>            [outputPlainData appendData:key];<br>            <span class="hljs-keyword">if</span> (keyBuffer) &#123;<br>                free(keyBuffer);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (keyBuffer) &#123;<br>                free(keyBuffer);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">NSString</span> *outputPlainString = [[<span class="hljs-built_in">NSString</span> alloc] initWithData:outputPlainData encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    <span class="hljs-keyword">return</span> outputPlainString;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 私钥签名</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">NSString</span> *)signWithPrivateSecKey:(SecKeyRef)privateKey secPadding:(SecPadding)secPadding plainString:(<span class="hljs-built_in">NSString</span> *)plainString &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &lt; __IPHONE_10_0</span><br>    <span class="hljs-comment">// 原数据</span><br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    <span class="hljs-comment">// 哈希值算法，md5、sha1、sha224、sha256、sha384、sha512</span><br>    <span class="hljs-built_in">NSData</span> *hashData = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-built_in">NSInteger</span> digest_length = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">switch</span> (secPadding) &#123;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1MD5:<br>        &#123;<br>            digest_length = CC_MD5_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_MD5_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_MD5_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_MD5_CTX ctx;<br>            CC_MD5_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_MD5_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_MD5_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHAMD5 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_MD5_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA1:<br>        &#123;<br>            digest_length = CC_SHA1_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA1_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA1_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA1_CTX ctx;<br>            CC_SHA1_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA1_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA1_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA1 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA1_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA224:<br>        &#123;<br>            digest_length = CC_SHA224_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA224_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA224_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA256_CTX ctx;<br>            CC_SHA224_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA224_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA224_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA224 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA224_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA256:<br>        &#123;<br>            digest_length = CC_SHA256_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA256_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA256_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA256_CTX ctx;<br>            CC_SHA256_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA256_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA256_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA256 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA256_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA384:<br>        &#123;<br>            digest_length = CC_SHA384_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA384_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA384_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA512_CTX ctx;<br>            CC_SHA384_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA384_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA384_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA384 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA384_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA512:<br>        &#123;<br>            digest_length = CC_SHA512_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA512_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA512_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA512_CTX ctx;<br>            CC_SHA512_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA512_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA512_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA512 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA512_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (hashData) &#123;<br>        size_t signedHashBytesSize = SecKeyGetBlockSize(privateKey);<br>        <span class="hljs-comment">// Malloc a buffer to hold signature.</span><br>        uint8_t *signedHashBytes = malloc(signedHashBytesSize * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>        memset((<span class="hljs-keyword">void</span> *)signedHashBytes, <span class="hljs-number">0x0</span>, signedHashBytesSize);<br>        <span class="hljs-comment">// Sign the hash Data.</span><br>        OSStatus sanityCheck = noErr;<br>        sanityCheck = SecKeyRawSign(privateKey, secPadding, (<span class="hljs-keyword">const</span> uint8_t *)[hashData bytes], digest_length, (uint8_t *)signedHashBytes, &amp;signedHashBytesSize);<br>        <span class="hljs-keyword">if</span> (sanityCheck == noErr) &#123;<br>            <span class="hljs-comment">// Build up signed blob.</span><br>            <span class="hljs-built_in">NSData</span> *signedHash = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)signedHashBytes length:(<span class="hljs-built_in">NSUInteger</span>)signedHashBytesSize];<br>            <span class="hljs-keyword">if</span> (signedHashBytes) &#123;<br>                free(signedHashBytes);<br>            &#125;<br>            <span class="hljs-built_in">NSString</span> *signString = [signedHash base64EncodedStringWithOptions:<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">return</span> signString;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (signedHashBytes) &#123;<br>                free(signedHashBytes);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>    <span class="hljs-comment">// iOS10以上系统可以使用新的方法</span><br>    <span class="hljs-comment">// 原数据</span><br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    SecKeyAlgorithm Algorithm = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">switch</span> (secPadding) &#123;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA1:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA1;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA224:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA224;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA256:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA256;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA384:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA384;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA512:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA512;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (Algorithm) &#123;<br>        <span class="hljs-built_in">NSError</span> *error = <span class="hljs-literal">nil</span>;<br>        <span class="hljs-built_in">CFErrorRef</span> ee = (__bridge <span class="hljs-built_in">CFErrorRef</span>)error;<br>        <span class="hljs-built_in">CFDataRef</span> dataRef = SecKeyCreateSignature(privateKey, kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA1, (<span class="hljs-built_in">CFDataRef</span>)plainData, &amp;ee);<br>        <span class="hljs-keyword">if</span> (error) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">NSData</span> *signature = <span class="hljs-built_in">CFBridgingRelease</span>(dataRef);<br>            <span class="hljs-built_in">NSString</span> *signString = [signature base64EncodedStringWithOptions:<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">return</span> signString;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> 公钥验证签名</span><br><span class="hljs-comment"> */</span><br>- (<span class="hljs-built_in">BOOL</span>)verifyWithPublicSecKey:(SecKeyRef)publicKey secPadding:(SecPadding)secPadding plainString:(<span class="hljs-built_in">NSString</span> *)plainString signString:(<span class="hljs-built_in">NSString</span> *)signString &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &lt; __IPHONE_10_0</span><br>    <span class="hljs-comment">// 原数据</span><br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    <span class="hljs-comment">// 哈希值算法，md5、sha1、sha224、sha256、sha384、sha512</span><br>    <span class="hljs-built_in">NSData</span> *hashData = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-built_in">NSInteger</span> digest_length = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">switch</span> (secPadding) &#123;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1MD5:<br>        &#123;<br>            digest_length = CC_MD5_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_MD5_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_MD5_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_MD5_CTX ctx;<br>            CC_MD5_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_MD5_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_MD5_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHAMD5 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_MD5_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA1:<br>        &#123;<br>            digest_length = CC_SHA1_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA1_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA1_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA1_CTX ctx;<br>            CC_SHA1_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA1_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA1_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA1 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA1_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA224:<br>        &#123;<br>            digest_length = CC_SHA224_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA224_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA224_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA256_CTX ctx;<br>            CC_SHA224_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA224_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA224_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA224 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA224_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA256:<br>        &#123;<br>            digest_length = CC_SHA256_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA256_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA256_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA256_CTX ctx;<br>            CC_SHA256_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA256_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA256_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA256 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA256_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA384:<br>        &#123;<br>            digest_length = CC_SHA384_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA384_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA384_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA512_CTX ctx;<br>            CC_SHA384_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA384_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA384_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA384 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA384_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA512:<br>        &#123;<br>            digest_length = CC_SHA512_DIGEST_LENGTH;<br>            <span class="hljs-comment">// Malloc a buffer to hold hash.</span><br>            uint8_t *hashBytes = malloc(CC_SHA512_DIGEST_LENGTH * <span class="hljs-keyword">sizeof</span>(uint8_t));<br>            memset((<span class="hljs-keyword">void</span> *)hashBytes, <span class="hljs-number">0x0</span>, CC_SHA512_DIGEST_LENGTH);<br>            <span class="hljs-comment">// Initialize the context.</span><br>            CC_SHA512_CTX ctx;<br>            CC_SHA512_Init(&amp;ctx);<br>            <span class="hljs-comment">// Perform the hash.</span><br>            CC_SHA512_Update(&amp;ctx, (<span class="hljs-keyword">void</span> *)[plainData bytes], (CC_LONG)[plainData length]);<br>            <span class="hljs-comment">// Finalize the output.</span><br>            CC_SHA512_Final(hashBytes, &amp;ctx);<br>            <span class="hljs-comment">// Build up the SHA512 blob.</span><br>            hashData = [<span class="hljs-built_in">NSData</span> dataWithBytes:(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)hashBytes length:(<span class="hljs-built_in">NSUInteger</span>)CC_SHA512_DIGEST_LENGTH];<br>            <span class="hljs-keyword">if</span> (hashBytes) &#123;<br>                free(hashBytes);<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (hashData) &#123;<br>        <span class="hljs-comment">// 签名数据</span><br>        <span class="hljs-built_in">NSData</span> *signData = [[<span class="hljs-built_in">NSData</span> alloc] initWithBase64EncodedString:signString options:<span class="hljs-built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>];<br>        <span class="hljs-comment">// Get the size of the assymetric block.</span><br>        size_t signedHashBytesSize = SecKeyGetBlockSize(publicKey);<br>        OSStatus sanityCheck = noErr;<br>        sanityCheck = SecKeyRawVerify(publicKey, secPadding, (<span class="hljs-keyword">const</span> uint8_t *)[hashData bytes], digest_length, (<span class="hljs-keyword">const</span> uint8_t *)[signData bytes], signedHashBytesSize);<br>        <span class="hljs-keyword">if</span> (sanityCheck == noErr) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br>    <span class="hljs-comment">// iOS10以上系统可以使用新的方法</span><br>    <span class="hljs-comment">// 原数据</span><br>    <span class="hljs-built_in">NSData</span> *plainData = [plainString dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];<br>    <span class="hljs-comment">// 签名数据</span><br>    <span class="hljs-built_in">NSData</span> *signData = [[<span class="hljs-built_in">NSData</span> alloc] initWithBase64EncodedString:signString options:<span class="hljs-built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>];<br>    SecKeyAlgorithm Algorithm = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-keyword">switch</span> (secPadding) &#123;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA1:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA1;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA224:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA224;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA256:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA256;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA384:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA384;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> kSecPaddingPKCS1SHA512:<br>        &#123;<br>            Algorithm = kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA512;<br>        &#125;<br>            <span class="hljs-keyword">break</span>;<br>            <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (Algorithm) &#123;<br>        <span class="hljs-built_in">NSError</span> *error = <span class="hljs-literal">nil</span>;<br>        <span class="hljs-built_in">CFErrorRef</span> ee = (__bridge <span class="hljs-built_in">CFErrorRef</span>)error;<br>        Boolean boolen = SecKeyVerifySignature(publicKey, Algorithm, (<span class="hljs-built_in">CFDataRef</span>)plainData, (<span class="hljs-built_in">CFDataRef</span>)signData, &amp;ee);<br>        <span class="hljs-keyword">if</span> (error) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (boolen == <span class="hljs-literal">TRUE</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_10_0</span><br><br><span class="hljs-comment">// SecKeyRef转base64</span><br>- (<span class="hljs-built_in">NSString</span> *)base64StringFromSecKey:(SecKeyRef)secKey &#123;<br>    <span class="hljs-built_in">NSData</span> *keyData = (<span class="hljs-built_in">NSData</span> *)<span class="hljs-built_in">CFBridgingRelease</span>(SecKeyCopyExternalRepresentation(secKey, <span class="hljs-literal">NULL</span>));<br>    <span class="hljs-built_in">NSString</span> *base64 = [keyData base64EncodedStringWithOptions:<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">return</span> base64;<br>&#125;<br><br><span class="hljs-comment">// base64转SecKeyRef</span><br>- (SecKeyRef)publicSecKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString &#123;<br>    <span class="hljs-built_in">NSData</span> *keyData = [[<span class="hljs-built_in">NSData</span> alloc] initWithBase64EncodedString:keyString options:<span class="hljs-built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>];<br>    <br>    <span class="hljs-built_in">NSMutableDictionary</span> *options = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>    options[(__bridge <span class="hljs-keyword">id</span>)kSecAttrKeyType] = (__bridge <span class="hljs-keyword">id</span>) kSecAttrKeyTypeRSA;<br>    options[(__bridge <span class="hljs-keyword">id</span>)kSecAttrKeyClass] = (__bridge <span class="hljs-keyword">id</span>) kSecAttrKeyClassPublic;<br>    <br>    <span class="hljs-built_in">NSError</span> *error = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-built_in">CFErrorRef</span> ee = (__bridge <span class="hljs-built_in">CFErrorRef</span>)error;<br>    SecKeyRef ref = SecKeyCreateWithData((__bridge <span class="hljs-built_in">CFDataRef</span>)keyData, (__bridge <span class="hljs-built_in">CFDictionaryRef</span>)options, &amp;ee);<br>    <span class="hljs-keyword">if</span> (error) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, error.description);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ref;<br>&#125;<br><br>- (SecKeyRef)privateSecKeyFromBase64String:(<span class="hljs-built_in">NSString</span> *)keyString &#123;<br>    <span class="hljs-built_in">NSData</span> *keyData = [[<span class="hljs-built_in">NSData</span> alloc] initWithBase64EncodedString:keyString options:<span class="hljs-built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>];<br>    <br>    <span class="hljs-built_in">NSMutableDictionary</span> *options = [<span class="hljs-built_in">NSMutableDictionary</span> dictionary];<br>    options[(__bridge <span class="hljs-keyword">id</span>)kSecAttrKeyType] = (__bridge <span class="hljs-keyword">id</span>) kSecAttrKeyTypeRSA;<br>    options[(__bridge <span class="hljs-keyword">id</span>)kSecAttrKeyClass] = (__bridge <span class="hljs-keyword">id</span>) kSecAttrKeyClassPrivate;<br>    <br>    <span class="hljs-built_in">NSError</span> *error = <span class="hljs-literal">nil</span>;<br>    <span class="hljs-built_in">CFErrorRef</span> ee = (__bridge <span class="hljs-built_in">CFErrorRef</span>)error;<br>    SecKeyRef ref = SecKeyCreateWithData((__bridge <span class="hljs-built_in">CFDataRef</span>)keyData, (__bridge <span class="hljs-built_in">CFDictionaryRef</span>)options, &amp;ee);<br>    <span class="hljs-keyword">if</span> (error) &#123;<br>        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, error.description);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ref;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<p>调用示例：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;ViewController.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;SecKeyWrapper.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> () </span>&#123;<br>    SecKeyRef _publicKeyRef;<br>    SecKeyRef _privateKeyRef;<br>&#125;<br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-keyword">super</span> viewDidLoad];<br>    <span class="hljs-comment">// Do any additional setup after loading the view.</span><br>    <br>    _publicKeyRef = <span class="hljs-literal">NULL</span>;<br>    _privateKeyRef = <span class="hljs-literal">NULL</span>;<br>    SecKeyWrapper *secKeyWrapper = [SecKeyWrapper shareInstance];<br>    [secKeyWrapper generateKeyPair:<span class="hljs-number">1024</span> publicKey:&amp;_publicKeyRef privateKey:&amp;_privateKeyRef];<br><br>    <span class="hljs-built_in">NSString</span> *publicKeyBase64 = [secKeyWrapper base64StringFromSecKey:_publicKeyRef];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;公钥：%@&quot;</span>, publicKeyBase64);<br>    <span class="hljs-built_in">NSString</span> *privateKeyBase64 = [secKeyWrapper base64StringFromSecKey:_privateKeyRef];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;私钥：%@&quot;</span>, privateKeyBase64);<br><br>    <span class="hljs-built_in">NSString</span> *plainString = <span class="hljs-string">@&quot;123qweQWE测试@#%&amp;*&quot;</span>;<br><br>    <span class="hljs-built_in">NSString</span> *encryptedString = [secKeyWrapper secKeyEncryptWithPublicKey:_publicKeyRef plainString:plainString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;公钥加密：%@&quot;</span>, encryptedString]);<br><br>    <span class="hljs-built_in">NSString</span> *outputPlainString = [secKeyWrapper secKeyDecryptWithPrivateKey:_privateKeyRef encryptString:encryptedString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;私钥解密：%@&quot;</span>, outputPlainString]);<br><br>    <span class="hljs-built_in">NSString</span> *signString = [secKeyWrapper signWithPrivateSecKey:_privateKeyRef secPadding:kSecPaddingPKCS1SHA1 plainString:plainString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;私钥签名：%@&quot;</span>, signString]);<br><br>    <span class="hljs-built_in">BOOL</span> verify = [secKeyWrapper verifyWithPublicSecKey:_publicKeyRef secPadding:kSecPaddingPKCS1SHA1 plainString:plainString signString:signString];<br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;%@&quot;</span>, [<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@&quot;验证 %@&quot;</span>, verify ? <span class="hljs-string">@&quot;通过&quot;</span> : <span class="hljs-string">@&quot;不通过&quot;</span>]);<br>&#125;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure>

<h5 id="3、一些概念"><a href="#3、一些概念" class="headerlink" title="3、一些概念"></a>3、一些概念</h5><ol>
<li>公钥加密，私钥解密</li>
</ol>
<blockquote>
<p>对于二进制数据，加密时为了确定内容实际长度，所以在末尾需要用约定好的字符进行标记结尾，防止被内存中的垃圾数据等影响，这就是<code>padding</code>，<code>PKCS1</code>格式秘钥建议使用的<code>padding</code>为11字节</p>
</blockquote>
<blockquote>
<p>以1024位秘钥为例，公钥加密时支持最大字节数：证书位数/8-11=117，解密时支持最大字节数：证书位数/8=128</p>
</blockquote>
<ol start="2">
<li>私钥签名，公钥验签</li>
</ol>
<blockquote>
<p>私钥签名，公钥验签是为了对数据进行验证，确保数据没有被篡改</p>
</blockquote>
<blockquote>
<p>需要使用哈希值算法获取原数据的哈希值，哈希值特点是唯一性，一旦原数据发生变化，哈希值也会变化，再使用私钥对哈希值进行摘要签名，通过公钥验证后即可确保数据的保密性</p>
</blockquote>
<h5 id="4、遗留的问题"><a href="#4、遗留的问题" class="headerlink" title="4、遗留的问题"></a>4、遗留的问题</h5><p>在使用<code>Security</code>生成秘钥的过程中，发现一个问题：</p>
<blockquote>
<p>使用<code>Security</code>生成公钥私钥，其中私钥转成<code>base64</code>字符串后，可以使用<code>Openssl</code>的方法读取私钥，并使用<code>Openssl</code>的方法进行其他操作，但是公钥长度格式不对，无法使用<code>Openssl</code>的方法读取使用，如果要发送公钥给第三方，只能用<code>Openssl</code>的方法读取到公钥并发送，正常使用过程中，<code>Security</code>的公钥只能给<code>Security</code>自己的方法使用，对加密解密的功能没有影响，暂时无法找到合理的解释。</p>
</blockquote>
<p>另外，<code>Security</code>的部分方法在<code>iOS 10.0</code>后的系统才会生效，也没有找到以前以前系统中提供其他类似的方法，据网上资料了解，<code>Openssl</code>生成秘钥的方法有失败的可能，但是实际测试没有出现过，可能是测试数量不够多</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/iOS/">iOS</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/iOS/">iOS</a>
                    
                      <a class="hover-with-bg" href="/tags/RSA/">RSA</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/12/05/iOS%E5%B4%A9%E6%BA%83%E6%8E%92%E6%9F%A5/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">iOS崩溃排查</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/08/10/Flex%E5%B8%83%E5%B1%80%E7%AE%80%E6%9E%90/">
                        <span class="hidden-mobile">Flex布局简析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>










  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
